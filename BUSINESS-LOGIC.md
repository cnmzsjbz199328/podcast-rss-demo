# ğŸ™ï¸ AIæ’­å®¢ç”Ÿæˆç³»ç»Ÿ - ä¸šåŠ¡é€»è¾‘æ¢³ç†

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºCloudflare Workersçš„å…¨è‡ªåŠ¨æ’­å®¢ç”Ÿæˆç³»ç»Ÿï¼Œä¸»è¦åŠŸèƒ½æ˜¯å°†æ–°é—»å†…å®¹é€šè¿‡AIè½¬æ¢ä¸ºæ’­å®¢éŸ³é¢‘ï¼Œå¹¶æä¾›RSSè®¢é˜…æœåŠ¡ã€‚

## ğŸ—ï¸ æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 1. æ’­å®¢ç”Ÿæˆæµç¨‹ (`POST /generate`)

```
ç”¨æˆ·è¯·æ±‚ â†’ æ’­å®¢ç”Ÿæˆå™¨ â†’ æ–°é—»è·å– â†’ è„šæœ¬ç”Ÿæˆ â†’ è¯­éŸ³åˆæˆ â†’ æ–‡ä»¶å­˜å‚¨ â†’ æ•°æ®åº“ä¿å­˜ â†’ RSSæ›´æ–°
```

#### è¯¦ç»†æ­¥éª¤ï¼š

1. **æ¥æ”¶è¯·æ±‚**
   - æ¥å—`style`å‚æ•°ï¼ˆæ’­å®¢é£æ ¼ï¼‰
   - é»˜è®¤é£æ ¼ï¼š`news-anchor`

2. **ç”Ÿæˆå‰§é›†ID**
   - æ ¼å¼ï¼š`{style}-{timestamp}-{randomId}`
   - ç¤ºä¾‹ï¼š`news-anchor-2025-11-04T12-30-45-abc123`

3. **æ–°é—»è·å–ä¸å¤„ç†**
   - è°ƒç”¨BBC RSSæœåŠ¡è·å–æœ€æ–°æ–°é—»
   - è¿‡æ»¤å’Œæ•´ç†æ–°é—»å†…å®¹
   - æå–æ ‡é¢˜ã€æè¿°ã€é“¾æ¥ã€å‘å¸ƒæ—¶é—´

4. **è„šæœ¬ç”Ÿæˆ**
   - ä½¿ç”¨Google Gemini AIç”Ÿæˆæ’­å®¢è„šæœ¬
   - æ ¹æ®é£æ ¼åº”ç”¨ä¸åŒçš„æç¤ºè¯
   - è¿”å›ç»“æ„åŒ–çš„æ’­å®¢å†…å®¹

5. **è¯­éŸ³åˆæˆ**
   - è°ƒç”¨IndexTTS APIç”ŸæˆéŸ³é¢‘
   - æ”¯æŒå¼‚æ­¥å¤„ç†å’ŒSSEç›‘å¬
   - è¿”å›éŸ³é¢‘æ•°æ®å’Œå…ƒä¿¡æ¯

6. **æ–‡ä»¶å­˜å‚¨**
   - å°†è„šæœ¬å’ŒéŸ³é¢‘æ–‡ä»¶å­˜å‚¨åˆ°R2
   - ç”Ÿæˆå…¬å¼€è®¿é—®URL
   - è¿”å›å­˜å‚¨å…ƒæ•°æ®

7. **æ•°æ®åº“ä¿å­˜**
   - å°†å‰§é›†ä¿¡æ¯ä¿å­˜åˆ°D1æ•°æ®åº“
   - æ›´æ–°RSS Feed
   - è¿”å›å®Œæ•´çš„å‰§é›†æ•°æ®

## ğŸ¯ æ ¸å¿ƒä¸šåŠ¡å¯¹è±¡

### NewsItemï¼ˆæ–°é—»é¡¹ï¼‰
```javascript
{
  title: string,        // æ–°é—»æ ‡é¢˜
  description: string,  // æ–°é—»æ‘˜è¦
  link: string,         // åŸæ–‡é“¾æ¥
  pubDate: Date,        // å‘å¸ƒæ—¶é—´
  guid: string,         // å”¯ä¸€æ ‡è¯†
  category?: string[]   // åˆ†ç±»æ ‡ç­¾
}
```

### ScriptResultï¼ˆè„šæœ¬ç»“æœï¼‰
```javascript
{
  content: string,      // ç”Ÿæˆçš„è„šæœ¬å†…å®¹
  style: string,        // è„šæœ¬é£æ ¼
  wordCount: number,    // å­—æ•°ç»Ÿè®¡
  generatedAt: string,  // ç”Ÿæˆæ—¶é—´
  metadata: {
    model: string,      // AIæ¨¡å‹ä¿¡æ¯
    usageMetadata: {},  // APIä½¿ç”¨ç»Ÿè®¡
    styleConfig: {}     // é£æ ¼é…ç½®
  }
}
```

### VoiceResultï¼ˆè¯­éŸ³ç»“æœï¼‰
```javascript
{
  audioData: ArrayBuffer, // éŸ³é¢‘äºŒè¿›åˆ¶æ•°æ®
  format: string,        // éŸ³é¢‘æ ¼å¼ ('wav', 'mp3')
  duration: number,      // æ—¶é•¿(ç§’)
  fileSize: number,      // æ–‡ä»¶å¤§å°
  style: string,         // è¯­éŸ³é£æ ¼
  eventId?: string,      // TTSäº‹ä»¶ID (å¼‚æ­¥æ—¶)
  isAsync?: boolean,     // æ˜¯å¦å¼‚æ­¥å¤„ç†
  metadata: {}           // è¯­éŸ³ç”Ÿæˆå…ƒæ•°æ®
}
```

### StorageResultï¼ˆå­˜å‚¨ç»“æœï¼‰
```javascript
{
  scriptUrl: string,    // è„šæœ¬æ–‡ä»¶URL
  scriptKey: string,    // è„šæœ¬æ–‡ä»¶Key
  scriptSize: number,   // è„šæœ¬æ–‡ä»¶å¤§å°
  audioUrl?: string,    // éŸ³é¢‘æ–‡ä»¶URL
  audioKey?: string,    // éŸ³é¢‘æ–‡ä»¶Key
  fileSize?: number,    // éŸ³é¢‘æ–‡ä»¶å¤§å°
  uploadedAt: string,   // ä¸Šä¼ æ—¶é—´
  episodeId: string,    // å‰§é›†ID
  metadata: {
    stats: {},          // å­˜å‚¨ç»Ÿè®¡
    uploadedAt: string  // ä¸Šä¼ æ—¶é—´
  }
}
```

### Episodeï¼ˆå‰§é›†ï¼‰
```javascript
{
  id: string,           // å‰§é›†ID
  title: string,        // å‰§é›†æ ‡é¢˜
  description: string,  // å‰§é›†æè¿°
  audioUrl: string,     // éŸ³é¢‘URL
  audioKey: string,     // éŸ³é¢‘Key
  scriptUrl: string,    // è„šæœ¬URL
  scriptKey: string,    // è„šæœ¬Key
  duration: number,     // æ—¶é•¿(ç§’)
  fileSize: number,     // æ–‡ä»¶å¤§å°
  style: string,        // æ’­å®¢é£æ ¼
  transcript: string,   // æ–‡å­—ç¨¿
  status: string,       // çŠ¶æ€ ('published', 'draft')
  publishedAt: string,  // å‘å¸ƒæ—¶é—´
  createdAt: string,    // åˆ›å»ºæ—¶é—´
  ttsEventId: string,   // TTSäº‹ä»¶ID
  ttsStatus: string,    // TTSçŠ¶æ€ ('pending', 'completed', 'failed')
  metadata: {
    newsCount: number,  // æ–°é—»æ•°é‡
    wordCount: number,  // å­—æ•°ç»Ÿè®¡
    generatedAt: string,// ç”Ÿæˆæ—¶é—´
    scriptMetadata: {}, // è„šæœ¬å…ƒæ•°æ®
    voiceMetadata: {},  // è¯­éŸ³å…ƒæ•°æ®
    storageMetadata: {} // å­˜å‚¨å…ƒæ•°æ®
  }
}
```

## ğŸ”§ æ ¸å¿ƒæœåŠ¡ç»„ä»¶

### 1. RSSæœåŠ¡ (BbcRssService)
**èŒè´£**: è·å–å’Œè§£ææ–°é—»RSSæº
- è¾“å…¥: RSS URL
- è¾“å‡º: NewsItem[]

### 2. è„šæœ¬æœåŠ¡ (GeminiScriptService)
**èŒè´£**: ä½¿ç”¨AIç”Ÿæˆæ’­å®¢è„šæœ¬
- è¾“å…¥: NewsItem[], style
- è¾“å‡º: ScriptResult
- ç»„ä»¶:
  - GeminiApiClient: è´Ÿè´£APIè°ƒç”¨
  - ScriptStyleManager: é£æ ¼é…ç½®ç®¡ç†
  - ScriptFormatter: è„šæœ¬æ ¼å¼åŒ–

### 3. è¯­éŸ³æœåŠ¡ (IndexTtsVoiceService)
**èŒè´£**: å°†è„šæœ¬è½¬æ¢ä¸ºéŸ³é¢‘
- è¾“å…¥: script(string), style
- è¾“å‡º: VoiceResult
- ç»„ä»¶:
  - IndexTtsApiClient: APIè°ƒç”¨å’ŒSSEç›‘å¬
  - IndexTtsAudioProcessor: éŸ³é¢‘å¤„ç†
  - IndexTtsStyleManager: è¯­éŸ³é£æ ¼é…ç½®

### 4. å­˜å‚¨æœåŠ¡ (R2StorageService)
**èŒè´£**: æ–‡ä»¶å­˜å‚¨å’Œç®¡ç†
- è¾“å…¥: scriptResult, voiceResult
- è¾“å‡º: StorageResult
- ç»„ä»¶:
  - R2FileUploader: æ–‡ä»¶ä¸Šä¼ 
  - R2FileValidator: æ–‡ä»¶éªŒè¯

### 5. æ•°æ®åº“æœåŠ¡ (D1DatabaseService)
**èŒè´£**: æ•°æ®æŒä¹…åŒ–
- Episode CRUDæ“ä½œ
- ç»Ÿè®¡æŸ¥è¯¢

## ğŸ“¡ APIæ¥å£è®¾è®¡

### ç”Ÿæˆæ’­å®¢
```
POST /generate?style={style}
```

**å‚æ•°:**
- style: æ’­å®¢é£æ ¼ ('news-anchor', 'guo-de-gang', 'emotional')

**å“åº”:**
```json
{
  "success": true,
  "data": {
    "episodeId": "news-anchor-2025-11-04T12-30-45-abc123",
    "title": "ä»Šæ—¥çƒ­ç‚¹æ’­æŠ¥ - 11æœˆ4æ—¥",
    "description": "ä»Šæ—¥çƒ­ç‚¹æ–°é—»ï¼š...",
    "newsCount": 5,
    "wordCount": 1200,
    "duration": 180,
    "fileSize": 2880000,
    "scriptUrl": "https://r2.dev/scripts/...",
    "audioUrl": "https://r2.dev/audio/...",
    "eventId": "abc123",
    "isAsync": false,
    "generatedAt": "2025-11-04T12:30:45Z"
  }
}
```

### è·å–å‰§é›†åˆ—è¡¨
```
GET /episodes?limit=20&offset=0&style=news-anchor
```

### è·å–å‰§é›†è¯¦æƒ…
```
GET /episodes/{episodeId}
```

### RSS Feed
```
GET /rss.xml
```

## ğŸ¨ æ”¯æŒçš„æ’­å®¢é£æ ¼

### 1. news-anchor (æ–°é—»ä¸»æ’­)
- **ç‰¹ç‚¹**: ä¸“ä¸šã€å®¢è§‚ã€æ­£å¼
- **é€‚ç”¨åœºæ™¯**: æ–°é—»æ’­æŠ¥ã€æ—¶äº‹åˆ†æ
- **è¯­éŸ³é£æ ¼**: æ ‡å‡†æ™®é€šè¯ï¼Œè¯­é€Ÿé€‚ä¸­

### 2. guo-de-gang (éƒ­å¾·çº²é£æ ¼)
- **ç‰¹ç‚¹**: å¹½é»˜ã€åŒ…è¢±ã€æ¥åœ°æ°”
- **é€‚ç”¨åœºæ™¯**: å¨±ä¹æ–°é—»ã€ç”Ÿæ´»è¶£äº‹
- **è¯­éŸ³é£æ ¼**: å¸¦æœ‰æ–¹è¨€ç‰¹è‰²ï¼ŒèŠ‚å¥æ„Ÿå¼º

### 3. emotional (æƒ…æ„ŸåŒ–é£æ ¼)
- **ç‰¹ç‚¹**: æ¸©æš–ã€å…±æƒ…ã€å¯Œæœ‰æ„ŸæŸ“åŠ›
- **é€‚ç”¨åœºæ™¯**: æ„Ÿäººæ•…äº‹ã€äººæ–‡æŠ¥é“
- **è¯­éŸ³é£æ ¼**: æ¸©æŸ”èˆ’ç¼“ï¼Œæƒ…æ„Ÿä¸°å¯Œ

## ğŸ”„ å¼‚æ­¥å¤„ç†æœºåˆ¶

### TTSå¼‚æ­¥å¤„ç†æµç¨‹

1. **è¯·æ±‚å‘é€**
   - è°ƒç”¨IndexTTS API
   - è¿”å›event_idè¡¨ç¤ºå¼‚æ­¥å¤„ç†

2. **SSEç›‘å¬**
   - è¿æ¥SSEæµï¼š`/gradio_api/call/gen_single/{event_id}`
   - ç›‘å¬äº‹ä»¶ï¼š`heartbeat`, `complete`, `error`

3. **ç»“æœå¤„ç†**
   - complete: ä¸‹è½½éŸ³é¢‘æ–‡ä»¶
   - error: æŠ›å‡ºå¼‚å¸¸
   - è¶…æ—¶: è¿”å›å¤„ç†ä¸­çŠ¶æ€

### æ•°æ®åº“çŠ¶æ€ç®¡ç†

- **pending**: TTSæ­£åœ¨å¤„ç†
- **completed**: TTSå¤„ç†å®Œæˆ
- **failed**: TTSå¤„ç†å¤±è´¥

## ğŸ“Š ä¸šåŠ¡è§„åˆ™

### æ–°é—»å¤„ç†è§„åˆ™
- è¿‡æ»¤é‡å¤æ–°é—»ï¼ˆåŸºäºæ ‡é¢˜ç›¸ä¼¼åº¦ï¼‰
- é™åˆ¶æ–°é—»æ•°é‡ï¼ˆé»˜è®¤5-10æ¡ï¼‰
- æŒ‰æ—¶é—´å€’åºæ’åˆ—
- è¿‡æ»¤è¿‡æ—§çš„æ–°é—»ï¼ˆ24å°æ—¶å†…ï¼‰

### è„šæœ¬ç”Ÿæˆè§„åˆ™
- å­—æ•°æ§åˆ¶ï¼š1000-2000å­—
- åŒ…å«æ–°é—»æ ‡é¢˜å’Œå…³é”®ä¿¡æ¯
- æ ¹æ®é£æ ¼è°ƒæ•´è¯­è¨€é£æ ¼
- ä¿æŒå®¢è§‚ä¸­ç«‹ï¼ˆé™¤å¹½é»˜é£æ ¼å¤–ï¼‰

### éŸ³é¢‘ç”Ÿæˆè§„åˆ™
- é‡‡æ ·ç‡ï¼š22050Hz
- æ ¼å¼ï¼šMP3/WAV
- æ—¶é•¿æ§åˆ¶ï¼š3-10åˆ†é’Ÿ
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼š50MB

### å­˜å‚¨è§„åˆ™
- æ–‡ä»¶å‘½åï¼š`{type}/{style}/{timestamp}-{random}.{ext}`
- è„šæœ¬ï¼šTXTæ ¼å¼ï¼ŒUTF-8ç¼–ç 
- éŸ³é¢‘ï¼šMP3æ ¼å¼ï¼Œé«˜å“è´¨
- ç¼“å­˜ç­–ç•¥ï¼š1å¹´CDNç¼“å­˜

## ğŸš¨ é”™è¯¯å¤„ç†ç­–ç•¥

### ç½‘ç»œé”™è¯¯
- é‡è¯•æœºåˆ¶ï¼š3æ¬¡é‡è¯•
- æŒ‡æ•°é€€é¿ï¼š1s, 2s, 4s
- è¶…æ—¶æ§åˆ¶ï¼š30ç§’

### APIé”™è¯¯
- Gemini: é…é¢ã€é€Ÿç‡é™åˆ¶ã€æœåŠ¡é”™è¯¯
- IndexTTS: éŸ³é¢‘ç”Ÿæˆå¤±è´¥ã€SSEé”™è¯¯
- R2/D1: å­˜å‚¨å¤±è´¥ã€ç½‘ç»œé”™è¯¯

### ä¸šåŠ¡é”™è¯¯
- æ–°é—»è·å–å¤±è´¥ï¼šè¿”å›é»˜è®¤æ–°é—»
- è„šæœ¬ç”Ÿæˆå¤±è´¥ï¼šè¿”å›é”™è¯¯ä¿¡æ¯
- éŸ³é¢‘ç”Ÿæˆå¤±è´¥ï¼šæ ‡è®°ä¸ºpendingï¼Œå…è®¸é‡è¯•

## ğŸ“ˆ ç›‘æ§å’Œç»Ÿè®¡

### æ€§èƒ½æŒ‡æ ‡
- ç”Ÿæˆè€—æ—¶ï¼šä»è¯·æ±‚åˆ°å®Œæˆçš„æ€»æ—¶é—´
- APIè°ƒç”¨ç»Ÿè®¡ï¼šå„æœåŠ¡çš„æˆåŠŸç‡å’Œå“åº”æ—¶é—´
- æ–‡ä»¶å¤§å°ç»Ÿè®¡ï¼šè„šæœ¬å’ŒéŸ³é¢‘çš„æ–‡ä»¶å¤§å°åˆ†å¸ƒ

### ä¸šåŠ¡æŒ‡æ ‡
- æ—¥ç”Ÿæˆé‡ï¼šæ¯æ—¥æˆåŠŸç”Ÿæˆçš„æ’­å®¢æ•°é‡
- ç”¨æˆ·ä½¿ç”¨æƒ…å†µï¼šAPIè°ƒç”¨é¢‘ç‡å’Œæ¨¡å¼
- é”™è¯¯ç‡ï¼šå„ç¯èŠ‚çš„å¤±è´¥ç‡ç»Ÿè®¡

### ç³»ç»Ÿå¥åº·
- æœåŠ¡å¯ç”¨æ€§ï¼šå„ç»„ä»¶çš„å¥åº·çŠ¶æ€
- å­˜å‚¨ä½¿ç”¨æƒ…å†µï¼šR2å’ŒD1çš„ä½¿ç”¨é‡
- ç¼“å­˜å‘½ä¸­ç‡ï¼šCDNç¼“å­˜æ•ˆæœ
